<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AleX Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 匯出工具 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      window.Firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot };
    </script>

    <style>
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sticky-col-1 { position: sticky; left: 0; z-index: 30; }
        .sticky-col-2 { position: sticky; left: 200px; z-index: 30; }
        thead th { position: sticky; top: 0; z-index: 40; }
        thead tr:nth-child(2) th { top: 45px; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ⚠️ 重要：請在此處填入您的 Firebase 配置 ---
       // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCiRXjyorwz9XGGPSlecBXmWhlf0dw4HWQ",
  authDomain: "alex-management-system.firebaseapp.com",
  projectId: "alex-management-system",
  storageBucket: "alex-management-system.firebasestorage.app",
  messagingSenderId: "243069616193",
  appId: "1:243069616193:web:65fa28b0bee4c63945c6c0"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        const DEFAULT_ACCESS_KEY = "admin123"; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'alex-mgmt-prod';

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block ${className}`}></i>;
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);
            const [config, setConfig] = useState({
                weeks: 12, startDate: '2026-02-09', onhand: '100',
                departments: [
                    { id: 'd1', name: "R&D Department" },
                    { id: 'd2', name: "QA / Testing" },
                    { id: 'd3', name: "Hardware Eng." },
                    { id: 'd4', name: "Project Management" },
                    { id: 'd5', name: "System Architect" }
                ],
                categories: [
                    { id: 'c1', name: 'Dev', hex: '#3b82f6' },
                    { id: 'c2', name: 'Testing', hex: '#f97316' },
                    { id: 'c3', name: 'UAT', hex: '#22c55e' },
                    { id: 'c4', name: 'Urgent', hex: '#ef4444' }
                ],
                schedule: {}, usageData: {}
            });

            const [selectedColor, setSelectedColor] = useState('#3b82f6');

            // 1. 初始化 Firebase 與 身份驗證
            useEffect(() => {
                const init = async () => {
                    try {
                        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.Firebase;
                        const app = initializeApp(myFirebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);

                        // 遵照 Rule 3: 先進行身份驗證
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        const unsubscribe = onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                        return () => unsubscribe();
                    } catch (e) {
                        console.error("Firebase Init Error", e);
                        setLoading(false);
                    }
                };
                init();
            }, []);

            // 2. 訂閱雲端資料 (修正路徑為 6 個分段)
            useEffect(() => {
                if (!db || !user) return; // 遵照 Rule 3: 確保已驗證
                const { doc, onSnapshot } = window.Firebase;
                
                // 修正路徑: artifacts(1)/appId(2)/public(3)/data(4)/projects(5)/main(6)
                const projectDoc = doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');

                const unsubscribe = onSnapshot(projectDoc, (s) => {
                    if (s.exists()) setConfig(s.data());
                }, (error) => {
                    console.error("Snapshot Error:", error);
                });

                return () => unsubscribe();
            }, [db, user]);

            // 儲存函式
            const save = async (newData) => {
                if (!isAdmin || !db || !user) return;
                const { doc, setDoc } = window.Firebase;
                try {
                    const projectDoc = doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');
                    await setDoc(projectDoc, newData);
                } catch (e) {
                    console.error("Save Error:", e);
                }
            };

            const toggleAdmin = () => {
                if (isAdmin) setIsAdmin(false);
                else {
                    const k = prompt("Enter Access Key:");
                    if (k === DEFAULT_ACCESS_KEY) setIsAdmin(true);
                }
            };

            const getWeekRange = (i) => {
                const s = new Date(config.startDate);
                s.setDate(s.getDate() + (i * 7));
                const e = new Date(s); e.setDate(e.getDate() + 4);
                const f = (d) => `${d.getMonth()+1}/${d.getDate()}`;
                return `${f(s)} - ${f(e)}`;
            };

            const weeklyTotals = useMemo(() => {
                return [...Array(config.weeks)].map((_, i) => 
                    config.departments.reduce((acc, d) => 
                        acc + (config.schedule[`${d.id}-${i}`] ? (parseFloat(config.usageData[d.id]) || 0) : 0), 0)
                );
            }, [config]);

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-900 text-white font-bold">Connecting to Cloud...</div>;

            return (
                <div className="min-h-screen bg-gray-100 p-4 font-sans">
                    <div className="max-w-[98%] mx-auto bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
                        {/* Header */}
                        <div className="bg-slate-800 text-white p-6 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 p-2 rounded-lg shadow-lg"><Icon name="layout" size={24} /></div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight">AleX Management System</h1>
                                    <div className="flex gap-3 mt-1 items-center">
                                        <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${isAdmin ? 'bg-green-500 text-white' : 'bg-slate-600 text-slate-400'}`}>
                                            {isAdmin ? 'Editor Mode' : 'View Only'}
                                        </span>
                                        <span className="text-[10px] text-slate-400 font-mono">Cloud Project: {appId}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-slate-700/50 px-3 py-1.5 rounded-lg border border-slate-600">
                                    <span className="text-xs font-bold text-blue-400 uppercase">Start:</span>
                                    <input type="date" disabled={!isAdmin} value={config.startDate} onChange={e => save({...config, startDate: e.target.value})} className="bg-transparent text-xs font-bold outline-none" />
                                </div>
                                <div className="flex items-center gap-2 bg-slate-700/50 px-3 py-1.5 rounded-lg border border-slate-600">
                                    <span className="text-xs font-bold text-orange-400 uppercase">Limit:</span>
                                    <input type="text" disabled={!isAdmin} value={config.onhand} onChange={e => save({...config, onhand: e.target.value})} className="bg-transparent text-xs font-bold w-10 text-center outline-none" />
                                </div>
                                <button onClick={toggleAdmin} className={`p-3 rounded-full transition-all ${isAdmin ? 'bg-blue-600 text-white rotate-12 shadow-blue-500/50 shadow-lg' : 'bg-slate-700 text-slate-400 hover:text-white'}`}>
                                    <Icon name={isAdmin ? "unlock" : "lock"} size={20} />
                                </button>
                            </div>
                        </div>

                        {/* Table Content */}
                        <div id="schedule-table-container" className="overflow-x-auto max-h-[75vh] bg-white">
                            <table className="w-full border-collapse table-fixed">
                                <thead>
                                    <tr className="bg-slate-100 border-b border-slate-200">
                                        <th className="w-[200px] p-4 text-left text-[10px] font-black text-slate-500 uppercase sticky-col-1 bg-slate-100 border-r border-slate-200 shadow-sm">Department</th>
                                        <th className="w-[100px] p-4 text-center text-[10px] font-black text-slate-500 uppercase sticky-col-2 bg-slate-100 border-r border-slate-200 shadow-sm">Usage</th>
                                        {[...Array(config.weeks)].map((_, i) => (
                                            <th key={i} className="py-3 text-center border-r border-slate-200 min-w-[140px] text-xs font-bold text-slate-700 bg-slate-100 uppercase tracking-widest">
                                                Week {i+1}
                                                <div className="text-[9px] text-slate-400 font-mono mt-0.5">{getWeekRange(i)}</div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {config.departments.map(dept => (
                                        <tr key={dept.id} className="group hover:bg-slate-50/50 transition-colors">
                                            <td className="p-2 border-b border-r border-gray-200 bg-white sticky-col-1 group-hover:bg-slate-50 font-bold text-slate-700 text-sm">
                                                <input disabled={!isAdmin} value={dept.name} onChange={e => {
                                                    const nd = config.departments.map(d => d.id === dept.id ? {...d, name: e.target.value} : d);
                                                    save({...config, departments: nd});
                                                }} className="bg-transparent border-none w-full focus:ring-1 focus:ring-blue-200 rounded px-2" />
                                            </td>
                                            <td className="p-2 border-b border-r border-gray-200 bg-white sticky-col-2 group-hover:bg-slate-50">
                                                <input disabled={!isAdmin} value={config.usageData[dept.id] || ""} onChange={e => {
                                                    const nu = {...config.usageData, [dept.id]: e.target.value};
                                                    save({...config, usageData: nu});
                                                }} className="w-full text-center text-sm font-bold bg-slate-50/50 rounded p-1 border-transparent focus:bg-white" placeholder="0" />
                                            </td>
                                            {[...Array(config.weeks)].map((_, i) => {
                                                const color = config.schedule[`${dept.id}-${i}`];
                                                return (
                                                    <td key={i} onClick={() => {
                                                        if (!isAdmin) return;
                                                        const ns = {...config.schedule};
                                                        const k = `${dept.id}-${i}`;
                                                        if (selectedColor === 'transparent') delete ns[k]; else ns[k] = selectedColor;
                                                        save({...config, schedule: ns});
                                                    }} className={`border-b border-r border-gray-100 p-1.5 ${isAdmin ? 'cursor-pointer' : ''}`}>
                                                        <div className="w-full h-12 rounded-lg shadow-sm transition-all" style={{ backgroundColor: color || '#f8fafc' }}>
                                                            {isAdmin && !color && <div className="w-full h-full flex items-center justify-center opacity-0 hover:opacity-100"><div className="w-2 h-2 rounded-full bg-slate-300"></div></div>}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-slate-100 border-t-2 border-slate-300">
                                        <td className="p-4 border-r border-slate-200 font-black text-slate-800 text-[10px] uppercase sticky-col-1 bg-slate-100">Weekly Sum</td>
                                        <td className="sticky-col-2 bg-slate-100 border-r border-slate-200"></td>
                                        {weeklyTotals.map((val, i) => {
                                            const isOver = val > parseFloat(config.onhand);
                                            return (
                                                <td key={i} className={`p-2 text-center border-r border-slate-200 font-black text-xs ${isOver ? 'bg-red-50' : 'bg-white'}`}>
                                                    <span className={isOver ? "text-red-600 scale-110 font-black" : val > 0 ? "text-blue-600" : "text-slate-300"}>
                                                        {val.toLocaleString()}
                                                    </span>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        {/* Footer / Toolbar */}
                        <div className="p-4 bg-slate-50 border-t flex justify-between items-center">
                            <div className="flex gap-2">
                                {config.categories.map(cat => (
                                    <button key={cat.id} onClick={() => setSelectedColor(cat.hex)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-xs font-bold transition-all ${selectedColor === cat.hex ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: cat.hex }}></div>
                                        {cat.name}
                                    </button>
                                ))}
                                <button onClick={() => setSelectedColor('transparent')} className={`px-3 py-1.5 rounded-lg border text-xs font-bold ${selectedColor === 'transparent' ? 'bg-slate-800 text-white' : 'bg-white'}`}>Clear</button>
                            </div>
                            <div className="text-[10px] font-mono text-slate-400 uppercase tracking-tighter">
                                AleX Management System v6.1 Cloud - Secure Path Fix
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>